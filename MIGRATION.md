# Recipe Library Migration Guide

This document outlines the migration from hardcoded recipes to a dynamic AI-generated recipe library powered by Firestore and Gemini AI.

## Overview

**Before**: Recipes were hardcoded in `lib/meal-suggestions.ts` as a static `MEAL_SUGGESTIONS` array
**After**: Recipes are stored in Firestore, generated by AI, and managed through an admin dashboard

## Benefits

- ✅ **Dynamic Content**: Admins can generate and publish new recipes without code changes
- ✅ **AI-Powered**: Gemini AI generates recipe steps, tips, and determines cooking requirements
- ✅ **Quality Control**: Draft → Published workflow with admin curation
- ✅ **Cook/Prepare Detection**: Automatic detection of cooking vs preparation-only recipes
- ✅ **Scalable**: Unlimited recipes in Firestore vs 50+ hardcoded
- ✅ **Offline Support**: LocalStorage caching for 24h
- ✅ **Real-time Updates**: Firestore real-time sync when recipes change

## Architecture Changes

### Data Flow (Before)
```
MEAL_SUGGESTIONS array → useRecipes() → Dashboard
```

### Data Flow (After)
```
Admin generates recipes → Firestore (published) → useRecipes() → Dashboard
                                                 ↓
                                           LocalStorage cache
```

## Migration Steps (For Deployment)

### 1. Deploy Firestore Rules
```bash
firebase deploy --only firestore:rules
```

This deploys the updated security rules that:
- Allow public read of published recipes
- Restrict draft recipes to admins
- Validate all recipe fields

### 2. Run Migration Script
```bash
cd /path/to/project
npx tsx scripts/migrate-recipes-to-firestore.ts
```

This script will:
- Generate missing recipe steps using Gemini AI
- Validate cook/prepare detection
- Save all recipes to Firestore with `status: 'published'`
- Generate a migration report

**Note**: You need a valid `GEMINI_API_KEY` in `.env.local`

### 3. Verify Migration
1. Check Firebase Console → Firestore → `recipes` collection
2. Verify ~50 recipes with `status: 'published'`
3. Check recipe steps are populated
4. Verify `requiresCooking` flags are set correctly

### 4. Test Admin Dashboard
1. Navigate to `/admin/recipes`
2. Verify you can see all published recipes
3. Test generating new recipes with AI
4. Test editing and publishing workflow

### 5. Test User Experience
1. Navigate to `/dashboard`
2. Verify meal suggestions appear correctly
3. Test "Cook Now" vs "Prepare Now" labels
4. Verify recipes with cooking show "Cook Now"
5. Verify recipes without cooking show "Prepare Now"

## Admin Features

### Recipe Generator (`/admin/recipes`)
- Generate 1-10 recipes at once with AI
- Customize calories, protein, meal type
- Preview AI-generated steps before saving
- Visual cook/prepare detection indicators

### Recipe Editor
- Edit any recipe field (name, description, steps, tips)
- Visual cook/prepare detection status
- Force cooking flag override
- Save as draft or publish immediately

### Recipe Workflow
```
Draft → (Admin Review) → Published → (Users can see)
                      ↓
                   Archived (hidden from users)
```

## API Changes

### useRecipes Hook

**Before**:
```typescript
// Returned hardcoded MEAL_SUGGESTIONS merged with media from Firestore
const { recipes, loading, error } = useRecipes()
```

**After**:
```typescript
// Returns published recipes from Firestore (cached in localStorage)
const { recipes, loading, error } = useRecipes()

// Optional: Clear cache to force refresh
import { clearRecipeCache } from '@/hooks/useRecipes'
clearRecipeCache()
```

### Firestore Operations

New functions in `lib/firestore-recipes.ts`:

```typescript
// Save recipe to Firestore
await saveRecipeToFirestore(recipe, userId)

// Get single recipe
const recipe = await getRecipeById('bf001')

// Get all published recipes
const recipes = await getPublishedRecipes({ mealType: 'breakfast' })

// Get drafts (admin only)
const drafts = await getDraftRecipes()

// Update recipe status
await updateRecipeStatus('bf001', 'published', userId)

// Track popularity
await incrementRecipePopularity('bf001')

// Bulk save (migration)
const result = await bulkSaveRecipes(recipes, userId)
```

## Cook/Prepare Detection

The system automatically determines if a recipe requires cooking by analyzing recipe steps for keywords:

**Cooking Keywords**:
- cook, bake, fry, boil, grill, simmer, roast, sauté
- toast, poach, heat, broil, sear, pan-fry, stir-fry
- steam, braise, stew, microwave, warm, reduce

**Preparation Keywords** (no cooking):
- mix, blend, combine, assemble, layer, top, arrange, stir

**Examples**:
- "Grill salmon for 5 minutes" → Requires Cooking → "Cook Now"
- "Blend protein powder and milk" → Prepare Only → "Prepare Now"

**Manual Override**:
Admins can force the `requiresCooking` flag in the recipe editor if AI detection is incorrect.

## Backwards Compatibility

### Seed Data Fallback
The hardcoded `MEAL_SUGGESTIONS` array remains in the codebase as:
1. **Seed data** for new deployments before migration
2. **Fallback** if Firestore fails or is empty
3. **Type definitions** for the MealSuggestion interface

### Cache Strategy
```typescript
// Priority order for recipe loading:
1. LocalStorage cache (if < 24h old)
2. Firestore published recipes
3. Hardcoded MEAL_SUGGESTIONS (fallback)
```

## Troubleshooting

### Migration Script Fails
```bash
# Check API key is set
echo $GEMINI_API_KEY  # or check .env.local

# Run with verbose output
npx tsx scripts/migrate-recipes-to-firestore.ts 2>&1 | tee migration.log
```

### Recipes Not Appearing
1. Check Firestore rules deployed: `firebase deploy --only firestore:rules`
2. Verify recipes have `status: 'published'` in Firestore
3. Clear cache: `localStorage.removeItem('wlpl_recipes_cache')`
4. Check browser console for errors

### Cook/Prepare Detection Wrong
1. Open admin dashboard `/admin/recipes`
2. Find the recipe and click "Edit"
3. Review recipe steps for cooking keywords
4. If needed, check "Force 'Requires Cooking' flag"
5. Save changes

### Permission Errors
- Recipes collection requires admin role
- Check user role in Firestore `users/{userId}` document
- Verify admin emails in `firestore.rules` `isSuperAdmin()` function

## Performance

### Before Migration
- **Bundle size**: ~50KB (hardcoded recipes in JS)
- **Load time**: Instant (bundled with app)
- **Offline**: Works (hardcoded in code)

### After Migration
- **Bundle size**: ~10KB (smaller fallback array)
- **Load time**: ~200ms first load, instant from cache
- **Offline**: Works (24h localStorage cache)
- **Scalability**: Unlimited recipes without code changes

## Security

### Firestore Rules
```javascript
// Users can only read published recipes
allow read: if resource.data.status == 'published'

// Admins can create/update/delete
allow write: if isAdmin()

// Field validation enforced
- status must be: 'draft' | 'published' | 'archived'
- calories > 0
- prepTime > 0
- max 4 images per recipe
```

### AI Generation
- Recipe generation requires admin authentication
- Gemini API key secured in environment variables
- Rate limiting: 2 seconds between AI calls

## Next Steps

1. ✅ **Phase 1**: Enhance Firestore schema → `lib/firestore-recipes.ts`
2. ✅ **Phase 2**: Build admin tools → `/admin/recipes`
3. ✅ **Phase 3**: Create migration script → `scripts/migrate-recipes-to-firestore.ts`
4. ✅ **Phase 4**: Update recipe fetching → `hooks/useRecipes.ts`
5. ⏳ **Phase 5**: Test cook/prepare detection with real recipes
6. ✅ **Phase 6**: Deploy Firestore rules → `firestore.rules`
7. ✅ **Phase 7**: Documentation → `MIGRATION.md`

## Rollback Plan

If issues arise, rollback is simple:

1. The old code still works - `useRecipes()` falls back to `MEAL_SUGGESTIONS`
2. To force old behavior temporarily:
   ```typescript
   // In useRecipes.ts, comment out Firestore query and return hardcoded data
   return { recipes: MEAL_SUGGESTIONS, loading: false, error: null }
   ```
3. No data loss - Firestore recipes remain intact
4. Can re-run migration script if needed

## Support

For issues or questions:
- Check Firebase Console for Firestore data
- Review browser console for JavaScript errors
- Check admin dashboard for recipe status
- Review this migration guide

---

**Migration completed**: [Date]
**Recipes migrated**: [Count]
**Admin dashboard**: `/admin/recipes`
