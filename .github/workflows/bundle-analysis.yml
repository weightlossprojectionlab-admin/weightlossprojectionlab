name: Bundle Size Analysis

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main

jobs:
  analyze:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Build PR
        run: npm run build

      - name: Analyze PR Bundle
        id: analyze-pr
        run: |
          # Extract bundle sizes from build output
          echo "Analyzing PR bundle sizes..."

          # Create a simple bundle report
          npm run build 2>&1 | tee build-pr.log

          # Parse build output for route sizes
          grep -E "^[○λ]\s+/.*kB" build-pr.log > pr-bundle.txt || true

          echo "PR bundle analysis complete"

      - name: Checkout Main Branch
        uses: actions/checkout@v4
        with:
          ref: main
          clean: false

      - name: Build Main
        run: |
          npm ci
          npm run build 2>&1 | tee build-main.log

      - name: Analyze Main Bundle
        id: analyze-main
        run: |
          # Parse build output for route sizes
          grep -E "^[○λ]\s+/.*kB" build-main.log > main-bundle.txt || true

      - name: Compare Bundles
        id: compare
        run: |
          echo "## 📦 Bundle Size Analysis" > comment.md
          echo "" >> comment.md
          echo "Comparing bundle sizes between \`main\` and this PR:" >> comment.md
          echo "" >> comment.md

          # Check if we have bundle data
          if [ ! -s pr-bundle.txt ] || [ ! -s main-bundle.txt ]; then
            echo "⚠️ Could not analyze bundle sizes. Build output may have changed." >> comment.md
            cat comment.md
            exit 0
          fi

          echo "| Route | Main | PR | Change | Status |" >> comment.md
          echo "|-------|------|----|----|--------|" >> comment.md

          # Simple comparison (basic implementation)
          # In production, use a proper bundle analyzer tool

          SIGNIFICANT_CHANGE=false
          TOTAL_CHANGE=0

          # Parse PR routes
          while IFS= read -r line; do
            route=$(echo "$line" | awk '{print $2}')
            size=$(echo "$line" | grep -oE '[0-9]+(\.[0-9]+)?\s+kB' | awk '{print $1}')

            # Find matching route in main
            main_size=$(grep "$route" main-bundle.txt | grep -oE '[0-9]+(\.[0-9]+)?\s+kB' | awk '{print $1}' || echo "0")

            if [ -n "$size" ] && [ -n "$main_size" ]; then
              # Calculate change
              change=$(echo "$size - $main_size" | bc)
              change_pct=$(echo "scale=1; ($change / $main_size) * 100" | bc 2>/dev/null || echo "0")

              # Determine status
              status="✅"
              if (( $(echo "$change > 10" | bc -l) )); then
                status="⚠️"
                SIGNIFICANT_CHANGE=true
              elif (( $(echo "$change > 5" | bc -l) )); then
                status="⚠️"
              fi

              # Format change
              if (( $(echo "$change > 0" | bc -l) )); then
                change_str="+${change} kB (+${change_pct}%)"
              else
                change_str="${change} kB (${change_pct}%)"
              fi

              echo "| $route | ${main_size} kB | ${size} kB | ${change_str} | ${status} |" >> comment.md

              TOTAL_CHANGE=$(echo "$TOTAL_CHANGE + $change" | bc)
            fi
          done < pr-bundle.txt

          echo "" >> comment.md

          # Summary
          if (( $(echo "$TOTAL_CHANGE > 0" | bc -l) )); then
            echo "**Total Increase:** +${TOTAL_CHANGE} kB" >> comment.md
          else
            echo "**Total Change:** ${TOTAL_CHANGE} kB" >> comment.md
          fi

          echo "" >> comment.md

          # Warnings
          if [ "$SIGNIFICANT_CHANGE" = true ]; then
            echo "### ⚠️ Significant Bundle Size Increase Detected" >> comment.md
            echo "" >> comment.md
            echo "One or more routes have increased by more than 10 kB." >> comment.md
            echo "Please review:" >> comment.md
            echo "- Are new dependencies necessary?" >> comment.md
            echo "- Can any code be lazy-loaded?" >> comment.md
            echo "- Can images be optimized?" >> comment.md
            echo "" >> comment.md
          else
            echo "✅ Bundle size changes are within acceptable limits." >> comment.md
          fi

          echo "" >> comment.md
          echo "---" >> comment.md
          echo "*Generated by Bundle Size Analysis workflow*" >> comment.md

          cat comment.md

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const comment = fs.readFileSync('comment.md', 'utf8');

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Bundle Size Analysis')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }
